window.dataLayer = window.dataLayer || [];
function gtag() {
  dataLayer.push(arguments);
}
gtag("js", new Date());
gtag("config", "G-LQ0R8JWVHC");

const data = [
  {
    name: "The Beatles",
    filtered: false,
    overallScore: 0,
    multiplies: [],
    songs: [
      {
        name: "Taxman",
        category: 0,
        link: { youtube: "l0zaebtU-CA" },
        end: 158,
      },
      {
        name: "Eleanor Rigby",
        category: 0,
        link: { youtube: "HuS5NuXRb5Y" },
        end: 131,
      },
      {
        name: "I'm Only Sleeping",
        category: 0,
        link: { youtube: "BT5j9OQ7Sh0" },
        end: 180,
      },
      {
        name: "Love You To",
        category: 0,
        link: { youtube: "s1X-q7MweIc" },
        end: 180,
      },
      {
        name: "Here, There And Everywhere",
        category: 0,
        link: { youtube: "xdcSFVXd3MU" },
        end: 144,
      },
      {
        name: "Yellow Submarine",
        category: 0,
        link: { youtube: "m2uTFF_3MaA" },
        end: 165,
      },
      {
        name: "She Said She Said",
        category: 0,
        link: { youtube: "rLzfo59AdEc" },
        end: 156,
      },
      {
        name: "Good Day Sunshine",
        category: 0,
        link: { youtube: "6e01nNA02vw" },
        end: 129,
      },
      {
        name: "And Your Bird Can Sing",
        category: 0,
        link: { youtube: "Uq0aeEYLkIE" },
        end: 120,
      },
      {
        name: "Tomorrow Never Knows",
        category: 0,
        link: { youtube: "pHNbHn3i9S4" },
        end: 179,
      },
      {
        name: "For No One",
        category: 0,
        link: { youtube: "ELlLIwhvknk" },
        end: 119,
      },
      {
        name: "Doctor Robert",
        category: 0,
        link: { youtube: "Tb9L3iAUhc0" },
        end: 134,
      },
      {
        name: "I Want To Tell You",
        category: 0,
        link: { youtube: "7kXusIyqQ2o" },
        end: 147,
      },
      {
        name: "Got To Get You Into My Life",
        category: 0,
        link: { youtube: "r95-7zfgtLw" },
        end: 147,
      },
    ],
  },
  {
    name: "Chamber",
    filtered: false,
    overallScore: 0,
    multiplies: ["uGoxfQ2H3ns"],
    songs: [
      {
        name: "Johannes Brahms - Trio for Clarinet",
        category: 1,
        link: { youtube: "1dAWECPfI20" },
        end: 1438,
      },
      {
        name: "Schubert - String Quintet",
        category: 1,
        link: { youtube: "GIY7jcVQZCg" },
        end: 890,
      },
      {
        name: "Shostakovich - String Quartet 1st",
        category: 1,
        link: { youtube: "uGoxfQ2H3ns" },
        start: 6,
        end: 297,
      },
      {
        name: "Shostakovich - String Quartet 2st",
        category: 1,
        link: { youtube: "uGoxfQ2H3ns" },
        start: 298,
        end: 469,
      },
      {
        name: "Shostakovich - String Quartet 3st",
        category: 1,
        link: { youtube: "uGoxfQ2H3ns" },
        start: 470,
        end: 722,
      },
    ],
  },
  {
    name: "Concerto",
    filtered: false,
    overallScore: 0,
    multiplies: ["sX8g0_A_lKg"],
    songs: [
      {
        name: "Mozart - Concerto No. 23",
        category: 2,
        link: { youtube: "PbLaW9eVsDg" },
        end: 435,
      },
      {
        name: "Mendelssohn - Violin Concerto",
        category: 2,
        link: { youtube: "kBWkKK3HgmM" },
        end: 768,
      },
      {
        name: "Rachmaninoff - Piano Concerto 1st",
        category: 2,
        link: { youtube: "sX8g0_A_lKg" },
        start: 26,
        end: 627,
      },
      {
        name: "Rachmaninoff - Piano Concerto 2st",
        category: 2,
        link: { youtube: "sX8g0_A_lKg" },
        start: 651,
        end: 1302,
      },
      {
        name: "Rachmaninoff - Piano Concerto 3st",
        category: 2,
        link: { youtube: "sX8g0_A_lKg" },
        start: 1318,
        end: 1936,
      },
    ],
  },
  {
    name: "Piano",
    filtered: false,
    overallScore: 0,
    multiplies: [],
    songs: [
      {
        name: "Bach",
        category: 3,
        link: { youtube: "1GXHjxvSi24" },
        end: 180,
      },
      {
        name: "Chopin - Nocturne op. 9",
        category: 3,
        link: { youtube: "ZtIW2r1EalM" },
        end: 330,
      },
      {
        name: "Schoenberg",
        category: 3,
        link: { youtube: "hVuNgPbza4Y" },
        end: 248,
      },
    ],
  },
  {
    name: "Sympony",
    filtered: false,
    overallScore: 0,
    multiplies: ["dTbesxdLwo8", "WLT55kPIFCo", "rP42C-4zL3w"],
    songs: [
      {
        name: "Beethoven - Symphony no.3 1st",
        category: 4,
        link: { youtube: "dTbesxdLwo8" },
        end: 808,
      },
      {
        name: "Beethoven - Symphony no.3 2st",
        category: 4,
        link: { youtube: "dTbesxdLwo8" },
        start: 811,
        end: 1798,
      },
      {
        name: "Beethoven - Symphony no.3 3st",
        category: 4,
        link: { youtube: "dTbesxdLwo8" },
        start: 1800,
        end: 2168,
      },
      {
        name: "Beethoven - Symphony no.3 4st",
        category: 4,
        link: { youtube: "dTbesxdLwo8" },
        start: 2168,
        end: 2863,
      },
      {
        name: "Claude Debussy - Prelude to the Afternoon",
        category: 4,
        link: { youtube: "9_7loz-HWUM" },
        end: 600,
      },
      {
        name: "Mahler - Symphony No. 1",
        category: 4,
        link: { youtube: "78oicMpxe2Y" },
        end: 973,
      },
      {
        name: "Richard Wagner - Tristan und Isolde",
        category: 4,
        link: { youtube: "-QX7dgBqfgw" },
        end: 631,
      },
      {
        name: "Tchaikovsky - Romeo and Juliet",
        category: 4,
        link: { youtube: "cn3U8AVoWdY" },
        end: 1257,
      },
      {
        name: "Sergei Prokofiev - Symphony no.1 1st",
        category: 4,
        link: { youtube: "WLT55kPIFCo" },
        start: 6,
        end: 265,
      },
      {
        name: "Sergei Prokofiev - Symphony no.1 2st",
        category: 4,
        link: { youtube: "WLT55kPIFCo" },
        start: 266,
        end: 513,
      },
      {
        name: "Sergei Prokofiev - Symphony no.1 3st",
        category: 4,
        link: { youtube: "WLT55kPIFCo" },
        start: 514,
        end: 602,
      },
      {
        name: "Sergei Prokofiev - Symphony no.1 4st",
        category: 4,
        link: { youtube: "WLT55kPIFCo" },
        start: 603,
        end: 845,
      },
      {
        name: "Igor Stravinsky - The Rite of Spring: Introduction",
        category: 4,
        link: { youtube: "rP42C-4zL3w" },
        end: 205,
      },
      {
        name: "Igor Stravinsky - The Rite of Spring: Dances of the Young Girls",
        category: 4,
        link: { youtube: "rP42C-4zL3w" },
        start: 209,
        end: 407,
      },
      {
        name: "Igor Stravinsky - The Rite of Spring:  Sacrificial Dance",
        category: 4,
        link: { youtube: "rP42C-4zL3w" },
        start: 1809,
        end: 2078,
      },
    ],
  },
];

class game {
  #categorizedScores = [];
  #correctOption = null;
  #isMultiply = false;
  #randomSeed = 500;
  #curOptions = [];
  #minOptions = 4;
  #player = null;
  #ready = false;
  #modes = [3, 4, 5, 6];

  #track = 0;

  #data = null;

  constructor(container) {
    this.container = container;
    // UI
    this.trackUI = container.querySelector("div.track_number");
    this.categoryUI = container.querySelector("div.category_sub");
    this.optionHolder = container.querySelector("div.option_holder");
    this.scoreBar = container.querySelector("div.score_bar");
    this.modeHolder = container.querySelector("div.modes");
    this.expandedScore = container.querySelector("div.expanded_score_bar");
    // Initialize Elements
    this.#player = new player(this);
  }

  initialize(cb) {
    this.#player.append(this.container);
    this.#data = data;
    for (let i in this.#data) {
      const cur = this.#data[i];
      const songs = [];
      for (let j in cur.songs) {
        const curSong = cur.songs[j];
        songs.push(
          new song(
            `${i}${j}`,
            curSong.name,
            i,
            curSong.link,
            curSong.start,
            curSong.end
          )
        );
      }
      cur.songs = songs;
    }
    cb(true);
    this.refreshScore();
    this.createModesUI();
    this.generateQuestion();
  }

  generateQuestion() {
    const category = this.chooseCategory();
    const song = this.songSelection(category);
    this.#track++;
    let songs = this.chooseUniqueSongsFromArray(
      [...category.songs],
      Math.min(this.#minOptions - 1, category.songs.length),
      song,
      category
    );
    songs.push(song);
    songs = shuffleArray(songs);
    this.updateTrackUI(category);
    this.generateOptions(category, song, songs);
    song.played++;
    this.#player.playSong(song);
    this.#ready = true;
  }

  generateOptions(category, song, songs) {
    songs.forEach((songOption) => {
      const isCorrect = songOption.uid == song.uid;
      const element = htmlToElement(
        `<div class="option m_nosel m_bt"><div class="option_name">${songOption.name}</div></div>`
      );
      this.optionHolder.appendChild(element);
      if (isCorrect) this.#correctOption = element;
      this.#curOptions.push(element);
      element.onclick = async () => {
        if (!this.#ready || !this.#player.isPlayed()) return;
        this.#ready = false;
        this.#curOptions.forEach((opt) => {
          opt.setAttribute("ready", "false");
        });
        if (isCorrect) {
          element.setAttribute("option", "true");
          category.overallScore++;
        } else {
          element.setAttribute("option", "false");
          this.#correctOption.setAttribute("option", "true");
        }
        this.refreshScore();
        await taskDelay(3400);
        this.#player.forceStop();
        this.#curOptions.forEach((opt) => {
          opt.remove();
        });
        this.#curOptions = [];
        this.#correctOption = null;
        this.generateQuestion();
      };
    });
  }

  chooseCategory() {
    let category = [];
    this.#data.forEach((cat) => {
      if (!cat.filtered) return;
      category.push(cat);
    });
    if (category.length == 0)
      return this.#data[
        randomNumber(0, this.#data.length * this.#randomSeed) %
          this.#data.length
      ];
    return category[
      randomNumber(0, category.length * this.#randomSeed) % category.length
    ];
  }

  songSelection(category) {
    const link =
      category.multiplies[
        randomNumber(0, category.multiplies.length * this.#randomSeed) %
          category.multiplies.length
      ];
    if (category.multiplies.length == 0 || !this.#isMultiply)
      return category.songs[
        randomNumber(0, category.songs.length * this.#randomSeed) %
          category.songs.length
      ];
    const songSelection = [];
    for (let i in category.songs) {
      const song = category.songs[i];
      if (song.link.youtube == link) songSelection.push(song);
    }
    if (songSelection.length == 0)
      return category.songs[
        randomNumber(0, category.songs.length * this.#randomSeed) %
          category.songs.length
      ];
    return songSelection[
      randomNumber(0, songSelection.length * this.#randomSeed) %
        songSelection.length
    ];
  }

  refreshScore() {
    if (this.#categorizedScores.length == 0) this.createScoreUI();
    let overallScore = 0;
    for (let i in this.#data) {
      const cur = this.#data[i];
      overallScore += cur.overallScore;
      let played = 0;
      cur.songs.forEach((song) => {
        played += song.played;
      });
      const cat_score =
        played == 0 ? 0 : Math.floor((cur.overallScore * 100) / played);
      this.#categorizedScores[i].innerHTML = `${
        cur.name
      }: <span style="font-weight:bold" result="${
        cat_score >= 80 ? "good" : cat_score < 50 ? "bad" : "natural"
      }">${cat_score}%</span>`;
    }
    const score =
      this.#track == 0 ? 0 : Math.floor((overallScore * 100) / this.#track);
    this.scoreBar.innerHTML = `Score: <span style="font-weight:bold" result="${
      score >= 80 ? "good" : score < 50 ? "bad" : "natural"
    }">${score}%</span> ${overallScore}/${this.#track}`;
  }

  createScoreUI() {
    for (let i in this.#data) {
      const cat = this.#data[i];
      const element = htmlToElement(
        `<div style="font-size:14px;color:white" class="element filter_category m_nosel m_bt">${cat.name}: <span style="font-weight:bold" result="bad">0%</span></div>`
      );
      this.#categorizedScores.push(element);
      this.expandedScore.appendChild(element);
      element.onclick = async () => {
        if (systemSettings.clicked[0]) return;
        systemSettings.clicked[0] = true;
        const isFiltered = cat.filtered == true ? true : false;
        cat.filtered = !isFiltered;
        !isFiltered
          ? element.setAttribute("filtered", "true")
          : element.removeAttribute("filtered");
        await taskDelay(300);
        systemSettings.clicked[0] = false;
      };
    }
  }

  createModesUI() {
    const data = [
      ["good", "EASY"],
      ["natural", "NORMAL"],
      ["bad", "HARD"],
      ["multi", "MULTIPLIES"],
    ];
    const elements = [];
    for (let i in data) {
      const curIndex = i;
      const cur = data[i];
      const element = htmlToElement(
        `<div style="font-size:14px;color:white" class="element mode_selection mode_selection_${cur[0]} m_nosel m_bt"><span result="${cur[0]}">${cur[1]}</span></div>`
      );
      if (i == 1) element.setAttribute("selected", "true");
      elements.push(element);
      this.modeHolder.appendChild(element);
      element.onclick = () => {
        if (this.#minOptions == this.#modes[curIndex]) return;
        elements.forEach((elem) => {
          elem.removeAttribute("selected");
          this.#isMultiply = false;
        });
        this.#minOptions = this.#modes[curIndex];
        if (curIndex == 3) this.#isMultiply = true;
        element.setAttribute("selected", "true");
      };
    }
  }

  updateTrackUI(category) {
    this.trackUI.innerHTML = `#${this.#track}`;
    this.categoryUI.innerHTML = category.name;
  }

  chooseUniqueSongsFromArray = (array, number, curSong, category) => {
    if (!Array.isArray(array) || typeof number != "number") return array;
    let counter = 0;
    const result = [];
    const multiplyVerify =
      this.#isMultiply && category.multiplies.includes(curSong.link.youtube);
    for (let i = 0; i < array.length; i++) {
      if (counter == number) return result;
      const tmpIndex = randomNumber(i, array.length);
      const tmpValue = array[tmpIndex];
      array[tmpIndex] = array[i];
      if (
        tmpValue.uid == curSong.uid ||
        (multiplyVerify && tmpValue.link.youtube != curSong.link.youtube)
      )
        continue;
      result.push(tmpValue);
      counter++;
    }
    return result;
  };
}

class song {
  #randomSeed = 500;

  constructor(uid, name, category, link, start, end) {
    this.uid = uid;
    this.name = name;
    this.category = category;
    this.link = link;
    this.start = start ? start : 0;
    this.end = end;
    this.played = 0;
  }

  generateTime(timelimit) {
    const diff = this.end - timelimit - this.start;
    const newDiff = randomNumber(0, diff * this.#randomSeed) % diff;
    return newDiff + this.start;
  }
}

class player {
  #startTime = 0;
  #started = false;
  #canPlay = false;
  #played = false;
  #finished = false;
  #maxReplays = 3;
  #timeLimit = 30;
  #plays = 0;

  constructor(parent) {
    this.parent = parent;
    this.playBt = this.parent.container.querySelector("input.play_bt");
    this.player = document.createElement("audio");
    this.player.setAttribute("class", "hidden_iframe");
    this.player.volume = 1;
    this.player.onloadedmetadata = () => {
      this.player.currentTime = this.#startTime;
      this.btStatus("LISTEN");
      this.#canPlay = true;
    };

    let clicked = false;

    this.player.ontimeupdate = () => {
      this.timeUpdate();
    };

    this.player.onerror = () => {
      this.btStatus("LISTEN");
      this.#canPlay = true;
    };

    this.playBt.onclick = () => {
      if (!this.#canPlay || clicked) return;
      clicked = true;
      this.#finished = false;
      this.player
        .play()
        .then((_) => {
          this.#canPlay = false;
          clicked = false;
          this.#played = true;
        })
        .catch((err) => {
          this.btStatus("LISTEN");
          this.#canPlay = true;
        });
    };
  }

  isPlayed() {
    return this.#played;
  }

  forceStop() {
    this.player.pause();
    this.player.src = "";
    this.#plays = 0;
    this.#finished = true;
    this.btStatus("LOADING");
    this.#startTime = 0;
    this.#played = false;
  }

  timeUpdate() {
    if (this.#canPlay || this.#finished) return;
    const elpased = Math.floor(
      this.#timeLimit + this.#startTime - this.player.currentTime
    );
    if (elpased <= 0) {
      this.player.pause();
      if (this.#plays >= this.#maxReplays - 1) {
        this.player.pause();
        if (!this.#finished) this.btStatus("LIMITED");
        this.#finished = true;
        return;
      }
      this.#plays++;
      this.player.currentTime = this.#startTime;
      this.player.play();
    }
    const time = `00:${
      elpased.toString().length == 1 ? `0${elpased}` : elpased
    }, ${this.#plays + 1} ↻`;
    if (!this.#finished) this.btStatus(time);
  }

  append(node) {
    node.appendChild(this.player);
  }

  onPause() {
    if (!this.#started || this.#finished) return;
  }

  playSong(song) {
    this.#canPlay = false;
    this.#startTime = song.generateTime(this.#timeLimit);
    const src = `./src/audio/${song.link.youtube}.aac`;
    this.player.src = src;
    this.btStatus("LOADING");
  }

  btStatus(status) {
    if (typeof status != "string") return;
    this.playBt.value = status;
  }
}

window.addEventListener("DOMContentLoaded", () => {
  const container = document.querySelector("div.container");
  const loading = document.querySelector("div.loading_container");
  if (!container || !loading) return;
  new game(container).initialize(async (status) => {
    await taskDelay(1000);
    if (!status) return;
    loading.style.opacity = 0;
    await taskDelay(300);
    loading.remove();
    container.style.display = "flex";
    await taskDelay(10);
    container.style.opacity = 1;
  });
});
